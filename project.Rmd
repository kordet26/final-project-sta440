---
title: "project"
author: "Kevin Ordet"
date: "2022-12-14"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lme4)
library(knitr)
```

```{r}
results <- read.csv("data/cook_popular_vote_tracker.csv")
deniers <- read.csv("data/fivethirtyeight_election_deniers.csv")
districts <- read.csv("data/urbanization-index-2022.csv")
fundraising <- read.csv("data/candidate_summary_2022.csv")
states <- read.csv("data/state_abbr.csv")
education <- read.csv("data/educ_by_dist.csv")
```

```{r}
house_deniers <- deniers%>%
  filter(Office == "Representative")

house_deniers <- merge(house_deniers, states)

house_deniers <- house_deniers %>%
  mutate(chars = nchar(District),
         dist = ifelse(chars == 8, "01", 
                       ifelse(chars==1, paste("0", District, sep=""),
                              District)),
         stcd = paste(abbr, dist, sep="-")) %>%
  select(stcd, "candidate"=Candidate, "stance"=Stance)

district_info <- merge(districts, house_deniers, by="stcd") %>%
  select("district"=stcd, 
         "pvi_22"=pvi_22,
         "gop_candidate"=candidate,
         "gop_candidate_stance"=stance,
         urbanindex, grouping) %>%
  filter(district != "AK-01")


house_results <- results %>%
  filter(dem_votes > 0, gop_votes > 0) %>%
  mutate(other_votes = ifelse(other_votes>0, other_votes, 0),
         other_votes = ifelse(is.na(other_votes), 0, other_votes),
         dem_pct = dem_votes / (dem_votes + gop_votes + other_votes),
         gop_pct = gop_votes / (dem_votes + gop_votes + other_votes),
         margin = 100*(dem_pct-gop_pct)) %>%
  select(district, incumbent, dem_pct, gop_pct, margin) %>%
  filter(district != "AZ-08", district!= "AZ-09", district!="WI-08")



df <- merge(house_results, district_info) %>%
  mutate(state=substr(district, 1, 2))
```

```{r message=FALSE}
house_fund <- fundraising %>%
  filter(Cand_Office == "H") %>%
  select("candidate" = Cand_Name, 
         "state" = Cand_Office_St,
         "district" = Cand_Office_Dist,
         "party" = Cand_Party_Affiliation,
         "raised" = Individual_Contribution) %>%
  mutate(chars = nchar(district),
         district = ifelse(district == 0, 1, district),
         dist = ifelse(chars==1, paste("0", district, sep=""), district),
         stcd = paste(state, dist, sep="-")) %>%
  mutate(party = ifelse(party=="DFL", "DEM", party)) %>%
  filter(party == "DEM" | party == "REP") %>%
  select(stcd, candidate, party, raised)

fund_summary <- house_fund %>%
  group_by("district" = stcd, party) %>%
  summarise(raised = max(raised)) %>%
  mutate(raised = ifelse(raised <0, 0, raised)) %>%
  ungroup()

dem <- fund_summary %>%
  filter(party == "DEM") %>%
  select(district, raised)

gop <- fund_summary %>%
  filter(party == "REP") %>%
  select(district, raised)

fund <- merge(dem, gop, by="district", suffixes=c("_dem", "_gop"), all=TRUE)
fund[is.na(fund)] <- 0




df <- merge(df, fund)

educ <- education %>%
  mutate(chars = nchar(district),
         district = ifelse(district == 0, 1, district),
         district = ifelse(chars==4, paste(substr(district, 1, 3),"0", substr(district, 4, 4), sep=""), district)) 

df <- merge(df, educ)

```




```{r}
df <- df %>%
  mutate(dem_fundraising_pct = 100*(raised_dem / (raised_dem + raised_gop)),
         centered_dem_fundraising_pct = dem_fundraising_pct-50,
         centered_urban_index = urbanindex - mean(urbanindex),
         centered_college_pct = pct_college - mean(pct_college),
         denier = ifelse(gop_candidate_stance=="Fully denied", 1, 0),
         inc = case_when(incumbent==0 ~ "open",
                                   incumbent==1 ~ "dem",
                                   incumbent==-1 ~ "gop"),
         area_type = case_when(urbanindex > 12.5 ~ "urban",
                               urbanindex > 10.5 ~ "suburban",
                               TRUE ~ "rural"))

df$resid <- df$margin - df$pvi_22

df <- df %>%
  mutate(pvi_group = case_when(pvi_22 > 15 ~ "Safe D",
                               pvi_22 > 5 ~ "Lean D",
                               pvi_22 > -5 ~ "Toss-up",
                               pvi_22 > -15 ~ "Lean R",
                               TRUE ~ "Safe R"))

```

# Introduction




# Exploratory Data Analysis
```{r}
(cor(df$pvi_22, df$margin))^2
```


```{r warning=FALSE, message=FALSE}

df$inc <- relevel(factor(df$inc), ref="open")
df$inc <- relevel(factor(df$inc), ref="gop")

df %>%
  ggplot(mapping=aes(x=pvi_22, y=margin, fill=inc, color=inc)) +
    geom_hline(yintercept=0) +
           geom_point(pch=21, size=2, color="black") +
  theme_bw()
```

The plot above shows the relationship between FiveThirtyEight's partisan lean `pvi_22` and the actual House vote `margin`. The points are colored by the 
incumbent party `inc`: blue for Democratic incumbents, red for Republican incumbents,
and green for open seats. 

Glaringly, the variation in `pvi_22` lean predicts 96% of the variation in `margin`. Although partisanship dominates, there are several examples of candidates defying expectations across the map.

From here on, `resid` is defined as the difference between `margin` and `pvi_22`.
Positive values of `resid` indicate Democratic outperformances, while negative values represent Republican ones. By comparing the actual margin to the partisanship of each district, we can evaluate how each party performed relative to expectations. 


```{r}
head(df %>% arrange(desc(resid)), 5) %>%
  select(district, pvi_22, margin, resid)

head(df %>% arrange(desc(-resid)), 5) %>%
  select(district, pvi_22, margin, resid)
```

The tables above show the five largest outperformances on each side of the aisle.

Three notable Democratic victories occurred in Republican-leaning districts, as
incumbents Marcy Kaptur (OH-09), Jared Golden (ME-02), and Sharice Davids (KS-03)
each won re-election by at least 6 points. Also worth mentioning is Mary Peltola's AK-01, which was not included in this analysis due to Alaska's ranked choice voting; the incumbent Democrat won Alaska's lone district by 10 points, even as Trump
carried the state by double digits two years prior.

On the Republican side, Mario Diaz-Balart (FL-26) and Carlos Gimenez (FL-28) each trounced to re-election in formerly competitive south Florida seats, which
continued to march rightward. Both districts backed Hillary Clinton just six years ago, and yet were won by Republicans by 42 and 27 points, respectively. In NY-02,
moderate Republican Andrew Garbarino won a second term by 22 points, even as Biden nearly carried the seat in 2020. 


The major theme, to be explored further, is that although partisanship reigns supreme, candidate quality and other factors still matter. The first of these
factors to be analyzed is incumbency.


```{r}
df %>%
  ggplot(mapping=aes(x=pvi_22, y=resid, fill=inc, color=inc)) +
    geom_hline(yintercept=0) +
           geom_point(pch=21, size=2, color="black") +
            geom_smooth(alpha=0.2)+
  theme_bw()
```

The plot above shows the `resid` of each district plotted against the partisan lean, with the points again colored by incumbent party `inc`. The trendlines highlight the
importance of incumbency in swing districts. In "crossover districts" that leaned towards the one party but were held by the other, incumbents tended to defy expectations by 5 to 10 points or more. This trend can be partially attributed to self-selection; only the largest outperformers are going to hold crossover districts
in the first place.

Another interesting point is the relative success of Democrats in Republican-tilting
open seats. In winning the national popular vote, Republicans overperformed partisanship in the majority of open seats. However, Democrats actually tended
to beat partisan lean in open seats with a lean between R+5 and R+15. 
Further analysis of the qualities of these districts and candidates will help explain this phenomenon.




```{r}
df %>%
  filter(pvi_group == "Lean R", inc=="open") %>%
  select(district, denier, pvi_22, margin, resid) %>%
  arrange(desc(resid))
  
```
The table above shows the Republican-leaning (`pvi_22` between -15 and -5) open seats sorted by Democratic outperformance `resid`. Of note, Democrat Marie Gluesenkamp Perez defeated election-denying Republican Joe Kent in WA-03, which leans 9 points Republican, in what has been dubbed "the upset of the cycle." In total, Democrats
outran expectations in 9 of the 12 districts and by an average of 2.1 points.



```{r message=FALSE}

df %>%
  ggplot(mapping=aes(x=dem_fundraising_pct, y=resid, fill=inc, color=inc)) +
  facet_wrap(~ inc) +
    geom_hline(yintercept=0) +
           geom_point(pch=21, size=2, color="black") +
  geom_smooth(alpha=0.1, method="lm") +
  theme_bw()


df %>%
  ggplot(mapping=aes(x=pct_college, y=resid, fill=inc, color=inc))+  facet_wrap(~ inc) +
    geom_hline(yintercept=0) +
           geom_point(pch=21, size=2, color="black") +
  geom_smooth(alpha=0.1, method="lm") +
  theme_bw()


df %>%
  ggplot(mapping=aes(x=urbanindex, y=resid, fill=inc, color=inc))+  facet_wrap(~ inc) +
    geom_hline(yintercept=0) +
           geom_point(pch=21, size=2, color="black") +
  geom_smooth(alpha=0.1, method="lm") +
  theme_bw()
```


The plots above show the Democratic outperformance `resid` plotted against
Democratic fundrasing share `dem_fundriasing_pct`, percent of population with a
college degree `pct_college`, and FiveThirtyEight's urban index. The plots are
also grouped by incumbent type `inc`. The first major observation is that Democrats
tended to outperform partisan lean in rural and high college-educated districts,
while Republicans did so in urban and low college-educated seats. 

Second, increased fundraising tended to result in overperformance of partisanship,
and incumbents dominated fundraising.






```{r warning=FALSE, message=FALSE}


# change colors
df$denier <- as.factor(df$denier)

df %>%
  ggplot(mapping=aes(x=pvi_22, y=resid, fill=
                       denier, color=denier)) +
           geom_point(pch=21, size=2, color="black") +
  geom_hline(yintercept=0) +
  geom_smooth(alpha=0.2) +
  theme_bw()


df %>%
  ggplot(mapping=aes(x=pvi_22, y=dem_fundraising_pct, fill=
                       denier, color=denier)) +
           geom_point(pch=21, size=2, color="black") +
  geom_smooth(alpha=0) +
  theme_bw() +
  ylim(0, 100)
```

# Methodology


\begin{align*}
\text{Margin}_{ij} = {} & (\gamma_{00} + u_{0j})+\gamma_{1}\text{PVI}+ \gamma_{2}\text{IncumbentD}  + \gamma_{3}\text{IncumbentR} + \gamma_{4}\text{FundraisingPctD} \, + \\ &
\gamma_{5}\text{UrbanIndex} + \gamma_{6}\text{CollegePct} + \gamma_{7}\text{DenierR} + \epsilon_{ij}
\end{align*}
\begin{align*}
\epsilon_{ij} &\sim \mathcal{N}(0, \sigma^2_\epsilon) \\
u_{0j} &\sim \mathcal{N}(0, \sigma^2_u)
\end{align*}



# Results

```{r}

df$denier <- as.numeric(df$denier)
df$inc <- relevel(factor(df$inc), ref="open")
df$area_type <- relevel(factor(df$area_type), ref="suburban")


m <- lmer(margin ~ pvi_22 + inc +
          centered_dem_fundraising_pct +
          centered_urban_index +
          centered_college_pct + denier + (1 | state), data=df)

coefs <- data.frame(coef(summary(m)))

rownames(coefs) = c("Intercept", "FiveThirtyEight Partisan Lean (PVI)",
                    "Democratic incumbent",
                    "Republican incumbent",
                    "Democratic percentage of fundraising (centered)",
                    "FiveThirtyEight Urbanization Index (centered)",
                    "College graduate percentage (centered)",
                    "Republican election denier")

coefs %>%
  kable(digits=3)
```



For an open seat with even partisanship, equal fundraising, the national average
for population density and educational attainment, and
a non-election denying Republican candidate, the expected outcome was a Republican
win by 1.21 percentage points. 


Holding all other variables constant and including random intercepts by state:


Districts with elected Republican incumbents were expected to vote 2.88 points
more Republican than open seats. Similarly, districts with elected Democratic incumbents were expected to vote 1.98 points more Republican than open seats.

For every one percentage point increase in the Democratic share of combined
fundraising, a district was expected to vote 0.099 points more Democratic.

For every one percentage point increase in the proportion of population with
college degrees, a district was expected to vote 0.107 points more Democratic.
(For reference, districts ranged from 8.4% to 78.8% college educated, and the
middle 80% of districts fall between 20.3% and 46.9% college educated.)

For every one point increase in the urbanization index, a district was expected
to vote 1.08 points more Republican. (For reference, the most urban districts
have urbanization indices just under 15, while the most rural districts have values
slightly above 8.)

Districts with election denying Republicans on the ballot were expected to
vote 1.15 points more Democratic than those without.



# Discussion


This finding is consistent with a declining, yet meaningful, incumbency advantage.



Excluding uncontested seats, the average swing from the 2020 presidential election was 5.09 points towards Republicans, implying a national environment that leans Republican by 0.64 points. This figure is similar to the 1.21-point Republican environment implied model's intercept.


# Appendix

```{r}
df %>%
  group_by(pvi_group) %>%
  summarise(districts = n(),
            pct_college = mean(pct_college),
            dem_fundraising_pct = mean(dem_fundraising_pct),
            urban_index = mean(urbanindex),
            pvi = mean(pvi_22)) %>%
  arrange(desc(pvi)) %>%
  select(-pvi)
```
